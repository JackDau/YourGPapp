<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Appointment Details - Your GP</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <a href="appointments.html" class="header-back">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
        </a>
        <h1 class="header-title">Appointment Details</h1>
      </div>
      <div class="header-right"></div>
    </header>

    <!-- Main Content -->
    <main class="main" style="padding-bottom: 70px;">
      <div class="page">
        <!-- Status Banner (for upcoming appointments) -->
        <div id="statusBanner" class="alert alert-info mb-4" style="display: none;">
          <span id="statusIcon">üìÖ</span>
          <span id="statusText">Upcoming appointment</span>
        </div>

        <!-- Appointment Summary Card -->
        <div class="card mb-4">
          <div class="card-body">
            <div style="text-align: center; padding: var(--space-3) 0; border-bottom: 1px solid var(--color-gray-200); margin-bottom: var(--space-4);">
              <div id="appointmentIcon" style="font-size: 2rem; margin-bottom: var(--space-2);">üìÖ</div>
              <h3 id="appointmentDate" style="font-size: var(--font-size-lg); margin-bottom: var(--space-1);">Loading...</h3>
              <p id="appointmentTimeRange" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold);">--:-- AM</p>
            </div>

            <div style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3) 0; border-bottom: 1px solid var(--color-gray-200);">
              <div id="practitionerAvatar" class="avatar" style="width: 40px; height: 40px; font-size: var(--font-size-sm);">--</div>
              <div>
                <p class="text-small text-muted">Practitioner</p>
                <p id="practitionerName" style="font-weight: var(--font-weight-medium);">Loading...</p>
                <p id="practitionerTitle" class="text-small text-muted">--</p>
              </div>
            </div>

            <div style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3) 0; border-bottom: 1px solid var(--color-gray-200);">
              <span id="typeIcon" style="font-size: 1.25rem;">üè•</span>
              <div>
                <p class="text-small text-muted">Appointment Type</p>
                <p id="typeName" style="font-weight: var(--font-weight-medium);">Loading...</p>
                <p id="typeDetails" class="text-small text-muted">-- minutes</p>
              </div>
            </div>

            <div style="display: flex; align-items: flex-start; gap: var(--space-3); padding: var(--space-3) 0;">
              <span id="locationIcon" style="font-size: 1.25rem;">üìç</span>
              <div>
                <p class="text-small text-muted">Location</p>
                <p id="locationName" style="font-weight: var(--font-weight-medium);">Your GP</p>
                <p id="locationAddress" class="text-small text-muted">123 Example Street<br>Canberra ACT 2600</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Reason for visit (if provided) -->
        <div id="reasonSection" class="card mb-4" style="display: none;">
          <div class="card-body">
            <h4 class="text-small text-muted mb-2">Reason for Visit</h4>
            <p id="reasonText" style="font-size: var(--font-size-base);"></p>
          </div>
        </div>

        <!-- Actions for upcoming appointments -->
        <div id="upcomingActions" style="display: none;">
          <a href="#" id="joinVideoBtn" class="btn btn-block mb-3" style="display: none; background-color: #0d9488; color: white;">
            <span style="display: flex; align-items: center; justify-content: center; gap: 8px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="23 7 16 12 23 17 23 7"/>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
              </svg>
              Join Video Call
            </span>
          </a>

          <a href="#" id="addToCalendarBtn" class="btn btn-secondary btn-block mb-3">
            Add to Calendar
          </a>

          <button type="button" id="rescheduleBtn" class="btn btn-secondary btn-block mb-3">
            Reschedule Appointment
          </button>

          <button type="button" id="cancelBtn" class="btn btn-ghost btn-block" style="color: var(--color-error);">
            Cancel Appointment
          </button>
        </div>

        <!-- Past appointment note -->
        <div id="pastNote" class="alert alert-gray" style="display: none;">
          <span>This appointment has already occurred.</span>
        </div>

        <!-- Cancelled note -->
        <div id="cancelledNote" class="alert alert-error" style="display: none;">
          <span>This appointment has been cancelled.</span>
        </div>
      </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <a href="dashboard.html" class="nav-item">
        <span class="nav-item-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
        </span>
        <span class="nav-item-label">Home</span>
      </a>
      <a href="appointments.html" class="nav-item active">
        <span class="nav-item-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
        </span>
        <span class="nav-item-label">Appointments</span>
      </a>
      <a href="requests.html" class="nav-item">
        <span class="nav-item-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="12" y1="18" x2="12" y2="12"/>
            <line x1="9" y1="15" x2="15" y2="15"/>
          </svg>
        </span>
        <span class="nav-item-label">Requests</span>
      </a>
      <a href="more.html" class="nav-item">
        <span class="nav-item-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="1"/>
            <circle cx="19" cy="12" r="1"/>
            <circle cx="5" cy="12" r="1"/>
          </svg>
        </span>
        <span class="nav-item-label">More</span>
      </a>
    </nav>
  </div>

  <!-- Cancel Confirmation Modal -->
  <div id="cancelModal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <h3 style="margin-bottom: 12px; font-size: 18px;">Cancel Appointment?</h3>
      <p style="color: #6b7280; margin-bottom: 16px;">Are you sure you want to cancel this appointment? This action cannot be undone.</p>
      <div style="display: flex; gap: 12px;">
        <button type="button" id="cancelModalNo" class="btn btn-secondary" style="flex: 1; padding: 12px; border: 1px solid #d1d5db; background: white; border-radius: 8px; cursor: pointer;">No, Keep It</button>
        <button type="button" id="cancelModalYes" class="btn btn-primary" style="flex: 1; padding: 12px; background-color: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer;">Yes, Cancel</button>
      </div>
    </div>
  </div>

  <style>
    /* Modal overlay - sits behind the modal content */
    #cancelModal .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 999;
    }
    #cancelModal.open .modal-overlay {
      opacity: 1;
      visibility: visible;
    }
    /* Modal content panel */
    #cancelModal .modal-content {
      position: relative;
      z-index: 1000;
      padding: 24px;
    }
    .alert-gray {
      background-color: var(--color-gray-100);
      color: var(--color-gray-700);
    }
    .alert-error {
      background-color: #fee2e2;
      color: var(--color-error);
    }
  </style>

  <script src="../js/appointments.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Get appointment ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const appointmentId = urlParams.get('id');

      if (!appointmentId) {
        window.location.href = 'appointments.html';
        return;
      }

      // Get appointment from storage
      const appointment = AppointmentsModule.getAppointmentById(appointmentId);

      if (!appointment) {
        window.location.href = 'appointments.html';
        return;
      }

      const practitioner = AppointmentsModule.PRACTITIONERS[appointment.practitionerId];
      const typeInfo = AppointmentsModule.APPOINTMENT_TYPES[appointment.typeId];

      // Get date and time from dateTime
      const dateObj = new Date(appointment.dateTime);
      const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
      const formattedDate = dateObj.toLocaleDateString('en-AU', options);

      // Format start time
      const hour24 = dateObj.getHours();
      const minutes = dateObj.getMinutes();
      const startPeriod = hour24 >= 12 ? 'PM' : 'AM';
      const startHour12 = hour24 > 12 ? hour24 - 12 : (hour24 === 0 ? 12 : hour24);
      const startTime = `${startHour12}:${minutes.toString().padStart(2, '0')} ${startPeriod}`;

      // Calculate end time
      const endMinutes = hour24 * 60 + minutes + appointment.duration;
      const endHour24 = Math.floor(endMinutes / 60);
      const endMin = endMinutes % 60;
      const endPeriod = endHour24 >= 12 ? 'PM' : 'AM';
      const endHour12 = endHour24 > 12 ? endHour24 - 12 : (endHour24 === 0 ? 12 : endHour24);
      const endTime = `${endHour12}:${endMin.toString().padStart(2, '0')} ${endPeriod}`;

      // Update display
      document.getElementById('appointmentIcon').textContent = appointment.mode === 'telehealth' ? 'üìπ' : 'üìÖ';
      document.getElementById('appointmentDate').textContent = formattedDate;
      document.getElementById('appointmentTimeRange').textContent = `${startTime} - ${endTime}`;

      // Practitioner
      const avatarEl = document.getElementById('practitionerAvatar');
      avatarEl.textContent = appointment.practitionerInitials;
      avatarEl.style.backgroundColor = appointment.practitionerColor;
      document.getElementById('practitionerName').textContent = appointment.practitionerName;
      document.getElementById('practitionerTitle').textContent = appointment.practitionerTitle;

      // Type
      document.getElementById('typeIcon').textContent = typeInfo ? typeInfo.icon : 'üè•';
      document.getElementById('typeName').textContent = appointment.typeName;
      const modeText = appointment.mode === 'telehealth' ? 'Video call' : 'In-person';
      document.getElementById('typeDetails').textContent = `${appointment.duration} minutes, ${modeText}`;

      // Location
      if (appointment.mode === 'telehealth') {
        document.getElementById('locationIcon').textContent = 'üíª';
        document.getElementById('locationName').textContent = 'Video Consultation';
        document.getElementById('locationAddress').innerHTML = 'Join your video consultation using<br>the button below when it\'s time.';

        // Show join video button
        const joinVideoBtn = document.getElementById('joinVideoBtn');
        joinVideoBtn.style.display = 'block';
        joinVideoBtn.href = `video-checkin.html?id=${appointmentId}`;

        // Check if within join window (10 minutes before to appointment end)
        const now = new Date();
        const appointmentStart = new Date(appointment.dateTime);
        const appointmentEnd = new Date(appointmentStart);
        appointmentEnd.setMinutes(appointmentEnd.getMinutes() + appointment.duration);

        const earlyJoinWindow = 10 * 60 * 1000; // 10 minutes in ms
        const joinWindowStart = new Date(appointmentStart.getTime() - earlyJoinWindow);

        const minutesUntilJoin = Math.ceil((joinWindowStart - now) / (1000 * 60));
        const isPastEnd = now > appointmentEnd;

        if (isPastEnd) {
          // Appointment has ended
          joinVideoBtn.style.display = 'none';
        } else if (now < joinWindowStart) {
          // Too early to join
          joinVideoBtn.classList.add('btn-disabled');
          joinVideoBtn.style.backgroundColor = '#9ca3af';
          joinVideoBtn.style.cursor = 'not-allowed';
          joinVideoBtn.innerHTML = `
            <span style="display: flex; align-items: center; justify-content: center; gap: 8px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
              Join available in ${minutesUntilJoin} min
            </span>
          `;
          joinVideoBtn.addEventListener('click', function(e) {
            e.preventDefault();
          });

          // Update countdown every minute
          setInterval(function() {
            const now = new Date();
            const minsLeft = Math.ceil((joinWindowStart - now) / (1000 * 60));
            if (minsLeft <= 0) {
              window.location.reload();
            } else {
              joinVideoBtn.innerHTML = `
                <span style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                  </svg>
                  Join available in ${minsLeft} min
                </span>
              `;
            }
          }, 60000);
        }
        // else: within join window, button works normally
      }

      // Reason for visit
      if (appointment.reason) {
        document.getElementById('reasonSection').style.display = 'block';
        document.getElementById('reasonText').textContent = appointment.reason;
      }

      // Check if upcoming or past
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const apptDateOnly = new Date(dateObj);
      apptDateOnly.setHours(0, 0, 0, 0);
      const isUpcoming = apptDateOnly >= today && appointment.status !== 'cancelled';
      const isPast = apptDateOnly < today;
      const isCancelled = appointment.status === 'cancelled';

      if (isCancelled) {
        document.getElementById('cancelledNote').style.display = 'flex';
      } else if (isUpcoming) {
        // Show status banner
        const statusBanner = document.getElementById('statusBanner');
        statusBanner.style.display = 'flex';

        const diffTime = apptDateOnly - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 0) {
          document.getElementById('statusIcon').textContent = '‚ú®';
          document.getElementById('statusText').textContent = 'Today';
          statusBanner.classList.remove('alert-info');
          statusBanner.classList.add('alert-success');
        } else if (diffDays === 1) {
          document.getElementById('statusText').textContent = 'Tomorrow';
        } else {
          document.getElementById('statusText').textContent = `In ${diffDays} days`;
        }

        // Show action buttons
        document.getElementById('upcomingActions').style.display = 'block';

        // Add to calendar
        document.getElementById('addToCalendarBtn').addEventListener('click', function(e) {
          e.preventDefault();

          const startDate = new Date(appointment.dateTime);
          const endDate = new Date(startDate);
          endDate.setMinutes(endDate.getMinutes() + appointment.duration);

          const formatForCal = (date) => {
            return date.toISOString().replace(/-|:|\.\d{3}/g, '');
          };

          const title = encodeURIComponent(`${appointment.typeName} with ${appointment.practitionerName}`);
          const details = encodeURIComponent(`Your GP Appointment\n${appointment.mode === 'telehealth' ? 'Video consultation' : 'In-person at Your GP'}`);
          const location = encodeURIComponent(appointment.mode === 'telehealth' ? 'Video Call' : 'Your GP, 123 Example Street, Canberra ACT 2600');

          const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${formatForCal(startDate)}/${formatForCal(endDate)}&details=${details}&location=${location}`;

          window.open(googleUrl, '_blank');
        });

        // Reschedule
        document.getElementById('rescheduleBtn').addEventListener('click', function() {
          // Store the appointment being rescheduled
          sessionStorage.setItem('yourgp_reschedule_id', appointmentId);

          // Start new booking with pre-filled type
          AppointmentsModule.updateBookingState({
            type: appointment.typeId,
            practitioner: appointment.practitionerId
          });

          window.location.href = 'appointments-book-step3.html';
        });

        // Cancel
        const cancelModal = document.getElementById('cancelModal');

        document.getElementById('cancelBtn').addEventListener('click', function() {
          cancelModal.classList.add('open');
        });

        document.getElementById('cancelModalNo').addEventListener('click', function() {
          cancelModal.classList.remove('open');
        });

        document.querySelector('.modal-overlay').addEventListener('click', function() {
          cancelModal.classList.remove('open');
        });

        document.getElementById('cancelModalYes').addEventListener('click', function() {
          const success = AppointmentsModule.cancelAppointment(appointmentId);

          if (success) {
            window.location.href = 'appointments.html';
          } else {
            alert('Failed to cancel appointment. Please try again.');
            cancelModal.classList.remove('open');
          }
        });

      } else if (isPast) {
        document.getElementById('pastNote').style.display = 'flex';
      }
    });
  </script>
</body>
</html>
