<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Select Doctor - Your GP</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <a href="appointments-book-step1.html" class="header-back">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
        </a>
        <h1 class="header-title">Book Appointment</h1>
      </div>
      <div class="header-right"></div>
    </header>

    <!-- Main Content -->
    <main class="main no-nav">
      <div class="page">
        <!-- Progress -->
        <div class="text-center mb-5">
          <p class="text-muted text-small">Step 2 of 4</p>
          <div class="progress-steps mt-3">
            <div class="progress-step">
              <div class="progress-step-dot completed"></div>
            </div>
            <div class="progress-step-line completed"></div>
            <div class="progress-step">
              <div class="progress-step-dot active"></div>
            </div>
            <div class="progress-step-line"></div>
            <div class="progress-step">
              <div class="progress-step-dot"></div>
            </div>
            <div class="progress-step-line"></div>
            <div class="progress-step">
              <div class="progress-step-dot"></div>
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: var(--font-size-xs); color: var(--color-gray-500); margin-top: var(--space-2);">
            <span style="color: var(--color-success);">Type ‚úì</span>
            <span style="color: var(--color-primary); font-weight: var(--font-weight-medium);">Doctor</span>
            <span>Time</span>
            <span>Confirm</span>
          </div>
        </div>

        <!-- Selected Type -->
        <div class="alert alert-info mb-4" style="padding: var(--space-3);" id="selectedType">
          <span id="typeIcon">üè•</span>
          <span id="typeName">Loading...</span>
        </div>

        <h2 style="font-size: var(--font-size-lg); margin-bottom: var(--space-4);">Who would you like to see?</h2>

        <!-- Practitioner List Container -->
        <div id="practitionerList">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </main>
  </div>

  <script src="../js/appointments.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const state = AppointmentsModule.getBookingState();

      // Check if we have a type selected
      if (!state.type) {
        window.location.href = 'appointments-book-step1.html';
        return;
      }

      // Get the appointment type info
      const typeInfo = AppointmentsModule.APPOINTMENT_TYPES[state.type];

      // Update the selected type display
      document.getElementById('typeIcon').textContent = typeInfo.icon;
      document.getElementById('typeName').textContent = `${typeInfo.name} (${typeInfo.duration} min)`;

      // Build practitioner list
      const listContainer = document.getElementById('practitionerList');

      // Add "Any Available" option
      const anyAvailableHtml = `
        <div class="card card-interactive practitioner-card" data-practitioner="any" style="display: block; margin-bottom: var(--space-3); cursor: pointer;">
          <div class="card-body">
            <div style="display: flex; align-items: center; gap: var(--space-3);">
              <div class="avatar" style="background-color: var(--color-gray-200); color: var(--color-gray-600);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
              </div>
              <div style="flex: 1;">
                <h3 style="font-size: var(--font-size-base); margin-bottom: var(--space-1);">Any Available Doctor</h3>
                <p class="text-small text-muted">Soonest availability</p>
              </div>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-gray-400)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="9 18 15 12 9 6"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="divider"></div>
      `;

      listContainer.innerHTML = anyAvailableHtml;

      // Add each practitioner
      Object.entries(AppointmentsModule.PRACTITIONERS).forEach(([id, practitioner]) => {
        const nextAvailable = AppointmentsModule.getNextAvailableDate(id);
        const availabilityText = nextAvailable
          ? AppointmentsModule.getRelativeDate(nextAvailable)
          : 'No availability';

        const isToday = nextAvailable && AppointmentsModule.getRelativeDate(nextAvailable) === 'Today';
        const isTomorrow = nextAvailable && AppointmentsModule.getRelativeDate(nextAvailable) === 'Tomorrow';

        const cardHtml = `
          <div class="card card-interactive practitioner-card" data-practitioner="${id}" style="display: block; margin-bottom: var(--space-3); cursor: pointer;">
            <div class="card-body">
              <div style="display: flex; align-items: center; gap: var(--space-3);">
                <div class="avatar" style="background-color: ${practitioner.color};">${practitioner.initials}</div>
                <div style="flex: 1;">
                  <h3 style="font-size: var(--font-size-base); margin-bottom: var(--space-1);">${practitioner.name}</h3>
                  <p class="text-small text-muted" style="margin-bottom: var(--space-1);">${practitioner.title}</p>
                  <p class="text-small" style="color: ${isToday || isTomorrow ? 'var(--color-success)' : 'var(--color-gray-600)'};">
                    Next available: ${availabilityText}
                  </p>
                </div>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-gray-400)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="9 18 15 12 9 6"/>
                </svg>
              </div>
            </div>
          </div>
        `;

        listContainer.innerHTML += cardHtml;
      });

      // Add click handlers
      document.querySelectorAll('.practitioner-card').forEach(card => {
        card.addEventListener('click', function() {
          const practitioner = this.dataset.practitioner;

          // If "any", find the first available
          if (practitioner === 'any') {
            // Find practitioner with soonest availability
            let soonest = null;
            let soonestDate = null;

            Object.keys(AppointmentsModule.PRACTITIONERS).forEach(id => {
              const nextDate = AppointmentsModule.getNextAvailableDate(id);
              if (nextDate && (!soonestDate || nextDate < soonestDate)) {
                soonestDate = nextDate;
                soonest = id;
              }
            });

            if (soonest) {
              AppointmentsModule.updateBookingState({ practitioner: soonest });
            }
          } else {
            AppointmentsModule.updateBookingState({ practitioner: practitioner });
          }

          // Navigate to step 3
          window.location.href = 'appointments-book-step3.html';
        });
      });
    });
  </script>
</body>
</html>
